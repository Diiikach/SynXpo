"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –≤–∏—à–ª–∏—Å—Ç
–∏ –∂–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∂–µ—Ä–µ–±—å—ë–≤–∫–∏.

–ò–ù–°–¢–†–£–ö–¶–ò–Ø: –ó–∞–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é QUIZ –Ω–∏–∂–µ –Ω–∞ –≤–∞—à—É –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞.
"""
import os
import asyncio
from telegram import Bot
from dotenv import load_dotenv
from database import Database

load_dotenv()

# ============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –í–ò–ö–¢–û–†–ò–ù–£ –ù–ê –°–í–û–Æ –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú –°–ö–†–ò–ü–¢–ê
# ============================================================================
QUIZ = {
    "question": "üéÑ –ö–∞–∫–æ–π –≤–∞—à –ª—é–±–∏–º—ã–π –∑–∏–º–Ω–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫?",
    "options": ["–ù–æ–≤—ã–π –≥–æ–¥", "–†–æ–∂–¥–µ—Å—Ç–≤–æ", "–î–µ–Ω—å —Å–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞", "23 —Ñ–µ–≤—Ä–∞–ª—è"]
}
# ============================================================================


async def send_quiz(telegram_id: int, bot: Bot, quiz: dict):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    message = (
        "üéÆ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –¥–ª—è –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!\n\n"
        f"{quiz['question']}\n\n"
        "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:\n"
    )
    
    for i, option in enumerate(quiz['options'], 1):
        message += f"{i}. {option}\n"
    
    message += "\nüí¨ –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞!"
    
    try:
        await bot.send_message(chat_id=telegram_id, text=message)
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}: {e}")
        return False


async def send_quizzes_to_waiting():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –≤—Å–µ–º –æ–∂–∏–¥–∞—é—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º"""
    token = os.getenv('BOT_TOKEN')
    
    if not token:
        print("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
        return
    
    bot = Bot(token=token)
    db = Database()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –≤–∏—à–ª–∏—Å—Ç–æ–º
    users = db.get_users_with_wishlist()
    
    if not users:
        print("‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –≤–∏—à–ª–∏—Å—Ç–æ–º")
        return
    
    print(f"–ù–∞–π–¥–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –≤–∏—à–ª–∏—Å—Ç–æ–º: {len(users)}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω–∞—è –∂–µ—Ä–µ–±—å—ë–≤–∫–∞
    session = db.get_session()
    try:
        from database import Match, User
        matches = session.query(Match).all()
        has_matching = len(matches) > 0
        
        if has_matching:
            # –ï—Å–ª–∏ –∂–µ—Ä–µ–±—å—ë–≤–∫–∞ —É–∂–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–º, –∫–æ–º—É –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            sent_users = set()
            for match in matches:
                if match.is_sent:
                    giver = session.query(User).filter_by(id=match.giver_id).first()
                    if giver:
                        sent_users.add(giver.telegram_id)
            
            users = [u for u in users if u.telegram_id not in sent_users]
            print(f"–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(users)}")
    finally:
        session.close()
    
    if not users:
        print("‚úÖ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∂–µ—Ä–µ–±—å—ë–≤–∫–∏!")
        return
    
    confirm = input(f"\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã {len(users)} —É—á–∞—Å—Ç–Ω–∏–∫–∞–º? (yes/no): ")
    if confirm.lower() != 'yes':
        print("–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    print("\nüìù –í–∏–∫—Ç–æ—Ä–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:")
    print(f"–í–æ–ø—Ä–æ—Å: {QUIZ['question']}")
    print("–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:")
    for i, option in enumerate(QUIZ['options'], 1):
        print(f"  {i}. {option}")

    confirm = input(f"\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç—É –≤–∏–∫—Ç–æ—Ä–∏–Ω—É {len(users)} —É—á–∞—Å—Ç–Ω–∏–∫–∞–º? (yes/no): ")
    if confirm.lower() != 'yes':
        print("–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    success_count = 0
    error_count = 0
    
    for user in users:
        success = await send_quiz(user.telegram_id, bot, QUIZ)
        if success:
            print(f"‚úÖ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ {user.first_name}")
            success_count += 1
        else:
            error_count += 1
        
        # –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã API
        await asyncio.sleep(0.5)
    
    print(f"\n‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success_count}")
    if error_count > 0:
        print(f"‚ùå –û—à–∏–±–æ–∫: {error_count}")


def main():
    asyncio.run(send_quizzes_to_waiting())


if __name__ == '__main__':
    main()

