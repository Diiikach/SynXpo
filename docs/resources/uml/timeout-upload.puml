@startuml timeout-upload
title Таймаут при загрузке файла

actor "Клиент A" as ClientA
participant "Сервер" as Server
actor "Клиент B" as ClientB

== Начало загрузки ==
ClientA -> Server: ASK_VERSION_INCREASE\n(file.txt, time=100)
Server -> Server: LAST_TRY = (100, connection_A)
Server -> Server: Установить блокировку
Server -> ClientA: VERSION_INCREASE_ALLOW
ClientA -> Server: FILE_WRITE (chunk 1)

== Клиент A зависает ==
note over ClientA
  Сетевая проблема
  или сбой клиента
end note

... 30 секунд без сообщений ...

== Сервер обнаруживает таймаут ==
Server -> Server: Таймаут: нет FILE_WRITE > 30 сек
Server -> Server: Откатить частичные изменения
Server -> Server: Снять блокировку
note right
  LAST_TRY остается = (100, connection_A)
end note

== Другой клиент может продолжить ==
ClientB -> Server: ASK_VERSION_INCREASE\n(file.txt, time=110)
Server -> Server: LAST_TRY.time = 100 < 110
Server -> Server: Файл свободен (блокировка снята)
Server -> ClientB: VERSION_INCREASE_ALLOW

== Клиент A восстанавливается ==
ClientA -> Server: FILE_WRITE (chunk 2)
Server -> ClientA: ERROR (TIMEOUT)\nБлокировка утеряна
ClientA -> ClientA: Начать алгоритм заново

@enduml
