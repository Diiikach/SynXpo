@startuml file-upload
title Отправка новой версии файла

actor "Клиент A" as ClientA
participant "Сервер" as Server
actor "Клиент B" as ClientB

== Обнаружение изменения ==
ClientA -> ClientA: Обнаружено изменение file.txt
ClientA -> ClientA: Сохранить копию в безопасное место
ClientA -> ClientA: FIRST_TRY_TIME = current_time()

== Запрос на увеличение версии ==
ClientA -> Server: ASK_VERSION_INCREASE\n(file.txt, FIRST_TRY_TIME)
Server -> Server: Проверить LAST_TRY
note right
  LAST_TRY.time < FIRST_TRY_TIME
  Файл свободен
end note
Server -> Server: LAST_TRY = (FIRST_TRY_TIME, connection_A)
Server -> Server: Установить блокировку на file.txt
Server -> ClientA: VERSION_INCREASE_ALLOW

== Отправка данных ==
ClientA -> Server: FILE_WRITE (chunk 1)
ClientA -> Server: FILE_WRITE (chunk 2)
ClientA -> Server: FILE_WRITE (chunk 3)
ClientA -> Server: FILE_WRITE_END

== Обновление версии ==
Server -> Server: Увеличить версию file.txt: v1 → v2
Server -> Server: Снять блокировку

== Уведомление других клиентов ==
Server -> ClientB: CHECK_VERSION\n(file.txt, version=2)

@enduml
